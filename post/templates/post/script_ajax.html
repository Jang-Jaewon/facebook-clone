<script type="text/javascript">
    (function(){ // ğŸ‘ˆ ìµëª… í•¨ìˆ˜
        const delegation = document.querySelector('#contents_container');
        const textField = document.querySelector('#text_field');

        function delegationFunc(e) {
        let elem = e.target; // ğŸ‘ˆ click ìœ„ì¹˜
        
        while (!elem.getAttribute('data-name')){ // elemì´ "data-name"ì„ í¬í•¨í•˜ê³  ìˆìœ¼ë©´ ì•„ë˜ ë°˜ë³µ
            elem = elem.parentNode;  // ë¶€ëª¨ nodeë¥¼ ê³„ì† ì°¾ì•„ì˜¬ë¼ê°

            if (elem.nodeName === 'BODY'){ // elemì´ 'BODY' íƒœê·¸ë¥¼ ë§Œë‹¤ë©´,

                elem = null;
                return; // ì¢…ë£Œ
            }
        }
        // Like Btn Ajax í†µì‹ 
        if (elem.matches('[data-name="heartbeat"]')){ // ğŸ‘ˆ elemì˜ ë‚´ìš© ì¤‘ì— [data-name="heartbeat"]ì´ ìˆë‹¤ë©´,,
            const pk = elem.getAttribute('name'); // ğŸ‘ˆ ê²Œì‹œê¸€ì˜ idê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤. = post.pk 
            // ajax í†µì‹  ë°©ë²•
            $.ajax({
                type: "POST", // ğŸ‘ˆ POST ë°©ì‹
                url: "{% url 'post:post_like' %}", // ğŸ‘ˆ url ê²½ë¡œ
                data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}'}, // ğŸ‘ˆ pkê°’ê³¼, csrf_token ì „ë‹¬
                dataType: "json", // // ğŸ‘ˆ json ë°©ì‹ ì„ íƒ
                success: function (response){  // ğŸ‘ˆ ì„±ê³µí–‡ì„ ë•Œ,,
                    const likeCount = document.querySelector('#like-count-'+pk); // ì¢‹ì•„ìš” ê°¯ìˆ˜ë¥¼ countí•˜ëŠ” ë¶€ë¶„ì„ ì¶”ì¶œí•œ ë’¤,
                    likeCount.innerHTML = response.like_count; // like_countë¥¼ htmlì— ë„£ì–´ì¤ë‹ˆë‹¤.
                },
                error: function (request, status, error){  // ğŸ‘ˆ ì‹¤íŒ¨í–ˆì„ ë•Œ,,
                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }
            });
        }
        // Bookmark Btn Ajax í†µì‹ 
        if (elem.matches('[data-name="bookmark"]')){ // data-nameì´ "bookmark"ë¼ë©´,
            // console.log('ë¶ë§ˆí¬');
            const pk = elem.getAttribute('name'); // í•´ë‹¹ ìš”ì†Œì—ì„œ nameê°’ì„ ê°€ì ¸ì˜´
            // console.log(pk);
            $.ajax({
                type: "POST",
                url: "{% url 'post:post_bookmark' %}",
                data: {'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}' },
                dataType: "json",
                success: function (response){ // ì„±ê³µí–‡ì„ ë•Œ, response ê°’ì„ ëŒë ¤ ë°›ê³ 
                    // í…œí”Œë¦¿ Text ë³€ê²½
                    let btn_bookmark_text = ""; // ë¹ˆì¹¸ì¸ ìƒìˆ˜ ìƒì„±
                    if(response.is_bookmarked === 'N'){
                        btn_bookmark_text = "ì €ì¥í•˜ê¸°";
                    } else if (response.is_bookmarked === 'Y') {
                        btn_bookmark_text = "ì €ì¥ë¨";
                    }
                    const bookmark = document.querySelector('.bookmark').innerHTML = btn_bookmark_text;
                },
                error: function (reqeust, status, error){ // ì‹¤íŒ¨í–ˆì„ ë•Œ, reqeust, status, errorr ê°’ì„ ë°›ìŒ
                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                }
            })
        }
        // ì¹œêµ¬ ìš”ì²­ Ajax í†µì‹ 
        if (elem.matches('[data-name="friend_request"]')){
            const user_id = elem.getAttribute('name');
            $.ajax({
                type: "POST",
                url: "{% url 'accounts:create_friend_request' %}",
                data: {
                    'pk': user_id,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                dataType: "json",
                success: function(response){
                    elem.innerHTML = "ì¹œêµ¬ìš”ì²­ì¤‘";
                },
            })
        }
        // ëŒ“ê¸€ ìƒì„± ajax í†µì‹ 
        if (elem.matches('[data-name="comment"]')){
            console.log('ìƒˆëŒ“ê¸€')
            const pk = elem.getAttribute('name'); // pkê°’ ê°€ì ¸ì˜¤ê¸°
            const content = document.querySelector('#add-comment-post'+pk+'>div>input[type=text]').value; // ëŒ“ê¸€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
            if(content.length > 140) {
                alert("ëŒ“ê¸€ì€ ìµœëŒ€ 140ì ì…ë ¥ ê°€ëŠ¥í•˜ë¹ˆë‹¤. í˜„ì¬ ê¸€ììˆ˜: "+ content.length);
                return;
            }
            if(content.length == 0) {
                alert("ê¸€ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”: "+ content.length);
                return;
            }
            $.ajax({
                type: "POST",
                url: "{% url 'post:comment_new' %}",
                data: {
                    'pk': pk,
                    'content': content,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                dataType: "html",
                success: function(data, textStatus, jqXHR){
                    document.querySelector("#comment-list-ajax-post"+pk).insertAdjacentHTML("afterbegin", data);
                    location.reload();
                }
            })
        }
        // ëŒ“ê¸€ ì‚­ì œ ajax í†µì‹ 
        if (elem.matches('[data-name="comment_delete"]')){
            console.log('ì‚­ì œ')
            const pk = elem.getAttribute('name');

            $.ajax({
                type: "POST",
                url: "{% url 'post:comment_delete' %}",
                data: {
                    'pk': pk,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                dataType: "json",
                success: function(response){
                    console.log('ì„±ê³µ')
                    if(response.status){
                        document.querySelector('#comment'+pk).remove();
                        location.reload();
                    }
                }
            })

        }
        elem.classList.toggle('active');
    }
    delegation.addEventListener('click', delegationFunc); // ğŸ‘ˆ '#contents_container'ê°€ í´ë¦­ë¬ì„ ë•Œ, delegationFuncì‹¤í–‰
})();
</script> 
